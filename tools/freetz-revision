#!/bin/bash

if [ -d .svn ]; then
	RB="$(LC_ALL=C svn info . | sed -n 's/^Relative URL: .*\///p')"
	RC="$(svnversion . | tr ":" "_")"
	[ "${RB}" != "trunk" -a "${RC}" == "${RC/_/}" -a "$1" ] && RC="$(LC_ALL=C svn info . | sed -n 's/^Last Changed Rev: //p')"
	[ "${RB}" != "trunk" -o "${RC}" != "${RC/_/}" -o "$1" ] && [ "$(svn status . | wc -l)" != "0" ] && RC="${RC%M}M"
	[ "$1" ] && RB="${RB/trunk/}" || RD="$(LC_ALL=C svn info . | sed -rn 's/^Last Changed Date: ([^ ]*).*/\1/p')"
elif [ -d .git ]; then
	RB="$(git rev-parse --abbrev-ref @)"
	RM="M"
	if ! git ls-files --other --directory --exclude-standard | read; then          # not added files
	if ! git --no-optional-locks status -uno --porcelain 2>/dev/null | read; then  # not commited files
	if [ "$(git rev-list --count HEAD ^@{upstream} 2>/dev/null)" == "0" ]; then    # not pushed commits
		RM=""                                                                  # what a good boy
	fi
	fi
	fi
	RC="$(( $(git rev-list --no-merges --count HEAD) +10#0$(cat {.,..}/.revdiff 2>/dev/null) ))${RM}-$(git rev-parse --verify --short @)"
	[ "$1" ] && RB="${RB/master/}" || RD="$(git log --pretty='format:%cd' --date=format:'%Y-%m-%d' -1 @)"
fi
R="${RC:+ $RC}${RB:+ $RB}${RD:+ $RD}"
[ "$1" ] && R="${R// /-}"
echo "$(cat .version)${R}"

